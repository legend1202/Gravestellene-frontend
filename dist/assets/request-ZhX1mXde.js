import{w as U,r as l,t as M,a as V,v as $,E as Q,N as J,c as K,b as X,d as Y,o as Z,j as s,C as ee,x as se,p as L,D,R as te,g as y,F as ae,O as re,y as ie,S as le,Q as oe,U as ne,u as de,H as ce}from"./index-HVmlIZYv.js";import{i as me,b as pe}from"./role-check-016q34qw.js";import{u as ue}from"./graveyard-DQg60Nxy.js";import{E as N}from"./empty-content-J0vuGcwT.js";import{R as fe}from"./rhf-select-aNSsfojf.js";import{R as he,a as xe,b as ve,d as ge,e as ye}from"./graveyard-table-row-zI0lFXLb.js";import{D as we,G as Ce,a as be,b as P}from"./DataGrid-z0EVE2U0.js";import"./Checkbox-m4MeutVJ.js";import"./SwitchBase-hsBiV9_9.js";import"./Chip-yi7Wa9Nd.js";import"./format-number-Ze4u1bEl.js";import"./index-WptKgvAm.js";import"./Autocomplete-WNTy16pS.js";import"./ClickAwayListener-_jfQIiHS.js";import"./Switch-f6XRvqtI.js";import"./Skeleton-R_VnUK7w.js";import"./TablePagination-qo-oKBHm.js";import"./FirstPage-lXeDo4YM.js";import"./TableCell-DndY-2IM.js";import"./FormControlLabel-o9IPCE2V.js";const Se=async(t,o)=>{const f=t.filter(a=>a.approved).map(async a=>{const h=o.filter(i=>i.serviceId===a.id).map(i=>{var x;const n=(x=i==null?void 0:i.graveyardDetails)==null?void 0:x.name;return i!=null&&i.approved?{...a,graveyardName:n,rapproved:!0}:{...a,graveyardName:n,rapproved:!1}});return h.length===0?a:h});return(await Promise.all(f)).flat()},je=async t=>{const o=t.map(async r=>({id:r.id,rapproved:r.approved,name:r.serviceDetails.name,unit:r.serviceDetails.unit,price:r.serviceDetails.price,graveyardName:r.graveyardDetails.name,description:r.serviceDetails.description}));return(await Promise.all(o)).flat()},k=[{value:"published",label:"Published"},{value:"draft",label:"Draft"}],Re={category:!1},Ie=["category","actions"];function Ge({user:t}){const{enqueueSnackbar:o}=U(),[u,f]=l.useState(!1),[r,w]=l.useState(!1),{t:a}=M(),h=V(),i=$(),{services:n,servicesLoading:x}=Q(t==null?void 0:t.userId),{rservices:p}=J(t==null?void 0:t.userId),{graveyards:C}=ue(),[v,b]=l.useState([]),[j,q]=l.useState([]),[A,F]=l.useState(Re),O=K().shape({id:X().required("Please select Graveyard!")}),E=l.useMemo(()=>({id:""}),[]),R=Y({resolver:Z(O),defaultValues:E}),{watch:T}=R,d=T();l.useEffect(()=>{t!=null&&t.role&&(f(me(t==null?void 0:t.role)),w(pe(t==null?void 0:t.role)))},[t==null?void 0:t.role]);const I=l.useCallback(async()=>{if(n&&n.length>0&&!r){const e=await Se(n,p);b(e)}if(r){const e=await je(p);b(e)}},[n,r,p]);l.useEffect(()=>{p&&I()},[p,I]);const _=async e=>{var c,g;try{const m=C.filter(S=>(S==null?void 0:S.id)===d.id);d!=null&&d.id||console.error("Select Graveyard!");const z={fellesraadId:((c=m[0])==null?void 0:c.fellesraadId)||"",graveyardId:(d==null?void 0:d.id)||"",serviceId:e||"",companyId:(t==null?void 0:t.userId)||""};(g=(await oe(z)).searchResults)!=null&&g.success&&o("Service request success!")}catch{window.prompt("Please select the Graveyard!")}},B=async e=>{const c=await ne(e);if(c.searchResults.success){const g=v.map(m=>m.id===c.searchResults.result.id?{...m,rapproved:c.searchResults.result.approved}:m);b(g),o("Approve success!")}else console.error("Approve not success!")},H=e=>r?[s.jsx(P,{showInMenu:!0,icon:s.jsx(y,{icon:"eva:checkmark-circle-2-fill"}),label:"Approve",onClick:()=>B(e.row.id)})]:u&&!("rapproved"in e.row)?[s.jsx(P,{showInMenu:!0,icon:s.jsx(y,{icon:"solar:trash-bin-trash-bold"}),label:a("Request"),onClick:()=>_(e.row.id)})]:[],G=[{field:"name",headerName:a("service_name"),flex:1,minWidth:100,hideable:!1,renderCell:e=>s.jsx(he,{params:e})},{field:"description",headerName:a("description"),minWidth:280,renderCell:e=>s.jsx(xe,{params:e})},{field:"price",headerName:a("price"),minWidth:110,renderCell:e=>s.jsx(ve,{params:e})},{field:"Graveyard",headerName:a("Graveyard"),width:280,type:"singleSelect",editable:!0,valueOptions:k,renderCell:e=>s.jsx(ge,{params:e})},{field:"Approve",headerName:a("Approve"),width:110,type:"singleSelect",editable:!0,valueOptions:k,renderCell:e=>s.jsx(ye,{params:e})},{type:"actions",field:"actions",headerName:" ",align:"right",headerAlign:"right",width:80,sortable:!1,filterable:!1,disableColumnMenu:!0,getActions:e=>H(e)}],W=()=>G.filter(e=>!Ie.includes(e.field)).map(e=>e.field);return s.jsxs(ee,{maxWidth:i.themeStretch?!1:"lg",sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[s.jsx(se,{heading:"List",links:[{name:a("service"),href:L.fellesraad.service.root},{name:a("list")}],action:u&&s.jsx(D,{component:te,href:L.fellesraad.service.create,variant:"contained",startIcon:s.jsx(y,{icon:"mingcute:add-line"}),children:a("new_service")}),sx:{mb:{xs:3,md:5}}}),C&&!r&&s.jsx(ae,{methods:R,children:s.jsx(fe,{fullWidth:!0,name:"id",label:"Graveyard",InputLabelProps:{shrink:!0},PaperPropsSx:{textTransform:"capitalize"},sx:{mb:1},children:C.map(e=>(e==null?void 0:e.approved)&&s.jsx(re,{value:e==null?void 0:e.id,children:e==null?void 0:e.name},e.id))})}),s.jsx(ie,{sx:{height:{xs:800,md:2},flexGrow:{md:1},display:{md:"flex"},flexDirection:{md:"column"},px:3},children:v&&v.length>0&&s.jsx(we,{disableRowSelectionOnClick:!0,rows:v,columns:G,loading:x,getRowHeight:()=>"auto",pageSizeOptions:[5,10,25],initialState:{pagination:{paginationModel:{pageSize:10}}},onRowSelectionModelChange:e=>{q(e)},columnVisibilityModel:A,onColumnVisibilityModelChange:e=>F(e),slots:{toolbar:()=>s.jsxs(Ce,{children:[s.jsx(be,{}),s.jsx(le,{spacing:1,flexGrow:1,direction:"row",alignItems:"center",justifyContent:"flex-end",children:!!j.length&&s.jsxs(D,{size:"small",color:"error",startIcon:s.jsx(y,{icon:"solar:trash-bin-trash-bold"}),onClick:h.onTrue,children:["Delete (",j.length,")"]})})]}),noRowsOverlay:()=>s.jsx(N,{title:"No Data"}),noResultsOverlay:()=>s.jsx(N,{title:"No results found"})},slotProps:{columnsPanel:{getTogglableColumns:W}}})})]})}function Je(){const{t}=M(),{user:o}=de();return s.jsxs(s.Fragment,{children:[s.jsx(ce,{children:s.jsxs("title",{children:[" ",`${t("services")}: ${t("list_of_services")}`]})}),s.jsx(Ge,{user:o})]})}export{Je as default};
