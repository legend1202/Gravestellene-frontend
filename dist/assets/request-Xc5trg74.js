import{w as z,r as l,t as M,a as U,v as $,E as Q,O as J,c as K,b as X,d as Y,o as Z,j as s,C as ee,x as se,p as L,J as D,R as te,g as y,F as re,Q as ae,y as ie,S as le,U as oe,V as ne,u as de,H as ce}from"./index-6zkZJZ_0.js";import{a as me,b as pe}from"./role-check-5Hlc5mGT.js";import{u as ue}from"./graveyard-bFbxtmTr.js";import{E as N}from"./empty-content-HvT411P_.js";import{R as fe}from"./rhf-select-pfcwEhwZ.js";import{R as he,a as xe,b as ve,d as ge,e as ye}from"./graveyard-table-row-W1P4YD1D.js";import{D as we}from"./DataGrid-0oOUlr-i.js";import{G as Ce,a as be}from"./GridToolbarQuickFilter-iJy9M-GH.js";import{G as P}from"./GridActionsCellItem-4URAVLzW.js";import"./Checkbox-17oiO5Jt.js";import"./SwitchBase-h1P8VXs0.js";import"./Chip-_NPTmUIn.js";import"./format-number-PdjRQbyC.js";import"./index-vZ0e5K7Y.js";import"./Autocomplete-FLEbJoTZ.js";import"./ClickAwayListener-HHCnqjVS.js";import"./Switch-pw_Y52P_.js";import"./Skeleton-hlsj9s3X.js";import"./TablePagination-wOOsGPl3.js";import"./FirstPage-iqsUhMfo.js";import"./TableCell-3UvXiDOO.js";import"./FormControlLabel-hLKdCECC.js";const Se=async(t,o)=>{const f=t.filter(r=>r.approved).map(async r=>{const h=o.filter(i=>i.serviceId===r.id).map(i=>{var x;const n=(x=i==null?void 0:i.graveyardDetails)==null?void 0:x.name;return i!=null&&i.approved?{...r,graveyardName:n,rapproved:!0}:{...r,graveyardName:n,rapproved:!1}});return h.length===0?r:h});return(await Promise.all(f)).flat()},je=async t=>{const o=t.map(async a=>({id:a.id,rapproved:a.approved,name:a.serviceDetails.name,unit:a.serviceDetails.unit,price:a.serviceDetails.price,graveyardName:a.graveyardDetails.name,description:a.serviceDetails.description}));return(await Promise.all(o)).flat()},k=[{value:"published",label:"Published"},{value:"draft",label:"Draft"}],Re={category:!1},Ie=["category","actions"];function Ge({user:t}){const{enqueueSnackbar:o}=z(),[u,f]=l.useState(!1),[a,w]=l.useState(!1),{t:r}=M(),h=U(),i=$(),{services:n,servicesLoading:x}=Q(t==null?void 0:t.userId),{rservices:p}=J(t==null?void 0:t.userId),{graveyards:C}=ue(),[v,b]=l.useState([]),[j,q]=l.useState([]),[A,F]=l.useState(Re),O=K().shape({id:X().required("Please select Graveyard!")}),E=l.useMemo(()=>({id:""}),[]),R=Y({resolver:Z(O),defaultValues:E}),{watch:T}=R,d=T();l.useEffect(()=>{t!=null&&t.role&&(f(me(t==null?void 0:t.role)),w(pe(t==null?void 0:t.role)))},[t==null?void 0:t.role]);const I=l.useCallback(async()=>{if(n&&n.length>0&&!a){const e=await Se(n,p);b(e)}if(a){const e=await je(p);b(e)}},[n,a,p]);l.useEffect(()=>{p&&I()},[p,I]);const _=async e=>{var c,g;try{const m=C.filter(S=>(S==null?void 0:S.id)===d.id);d!=null&&d.id||console.error("Select Graveyard!");const W={fellesraadId:((c=m[0])==null?void 0:c.fellesraadId)||"",graveyardId:(d==null?void 0:d.id)||"",serviceId:e||"",companyId:(t==null?void 0:t.userId)||""};(g=(await oe(W)).searchResults)!=null&&g.success&&o("Service request success!")}catch{window.prompt("Please select the Graveyard!")}},B=async e=>{const c=await ne(e);if(c.searchResults.success){const g=v.map(m=>m.id===c.searchResults.result.id?{...m,rapproved:c.searchResults.result.approved}:m);b(g),o("Approve success!")}else console.error("Approve not success!")},H=e=>a?[s.jsx(P,{showInMenu:!0,icon:s.jsx(y,{icon:"eva:checkmark-circle-2-fill"}),label:"Approve",onClick:()=>B(e.row.id)})]:u&&!("rapproved"in e.row)?[s.jsx(P,{showInMenu:!0,icon:s.jsx(y,{icon:"solar:trash-bin-trash-bold"}),label:r("Request"),onClick:()=>_(e.row.id)})]:[],G=[{field:"name",headerName:r("service_name"),flex:1,minWidth:100,hideable:!1,renderCell:e=>s.jsx(he,{params:e})},{field:"description",headerName:r("description"),minWidth:280,renderCell:e=>s.jsx(xe,{params:e})},{field:"price",headerName:r("price"),minWidth:110,renderCell:e=>s.jsx(ve,{params:e})},{field:"Graveyard",headerName:r("Graveyard"),width:280,type:"singleSelect",editable:!0,valueOptions:k,renderCell:e=>s.jsx(ge,{params:e})},{field:"Approve",headerName:r("Approve"),width:110,type:"singleSelect",editable:!0,valueOptions:k,renderCell:e=>s.jsx(ye,{params:e})},{type:"actions",field:"actions",headerName:" ",align:"right",headerAlign:"right",width:80,sortable:!1,filterable:!1,disableColumnMenu:!0,getActions:e=>H(e)}],V=()=>G.filter(e=>!Ie.includes(e.field)).map(e=>e.field);return s.jsxs(ee,{maxWidth:i.themeStretch?!1:"lg",sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[s.jsx(se,{heading:r("List"),links:[{name:r("service"),href:L.fellesraad.service.root},{name:r("List")}],action:u&&s.jsx(D,{component:te,href:L.fellesraad.service.create,variant:"contained",startIcon:s.jsx(y,{icon:"mingcute:add-line"}),children:r("new_service")}),sx:{mb:{xs:3,md:5}}}),C&&!a&&s.jsx(re,{methods:R,children:s.jsx(fe,{fullWidth:!0,name:"id",label:r("Graveyard"),InputLabelProps:{shrink:!0},PaperPropsSx:{textTransform:"capitalize"},sx:{mb:1},children:C.map(e=>(e==null?void 0:e.approved)&&s.jsx(ae,{value:e==null?void 0:e.id,children:e==null?void 0:e.name},e.id))})}),s.jsx(ie,{sx:{height:{xs:800,md:2},flexGrow:{md:1},display:{md:"flex"},flexDirection:{md:"column"},px:3},children:v&&v.length>0&&s.jsx(we,{disableRowSelectionOnClick:!0,rows:v,columns:G,loading:x,getRowHeight:()=>"auto",pageSizeOptions:[5,10,25],initialState:{pagination:{paginationModel:{pageSize:10}}},onRowSelectionModelChange:e=>{q(e)},columnVisibilityModel:A,onColumnVisibilityModelChange:e=>F(e),slots:{toolbar:()=>s.jsxs(Ce,{children:[s.jsx(be,{}),s.jsx(le,{spacing:1,flexGrow:1,direction:"row",alignItems:"center",justifyContent:"flex-end",children:!!j.length&&s.jsxs(D,{size:"small",color:"error",startIcon:s.jsx(y,{icon:"solar:trash-bin-trash-bold"}),onClick:h.onTrue,children:["Delete (",j.length,")"]})})]}),noRowsOverlay:()=>s.jsx(N,{title:"No Data"}),noResultsOverlay:()=>s.jsx(N,{title:"No results found"})},slotProps:{columnsPanel:{getTogglableColumns:V}}})})]})}function Xe(){const{t}=M(),{user:o}=de();return s.jsxs(s.Fragment,{children:[s.jsx(ce,{children:s.jsxs("title",{children:[" ",`${t("services")}: ${t("list_of_services")}`]})}),s.jsx(Ge,{user:o})]})}export{Xe as default};
